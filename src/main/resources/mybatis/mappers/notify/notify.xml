<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
<mapper namespace = "notify">

	<resultMap id ="notifyResult01" type = "NotifyVO">
		<result property = "not_Num" column = "not_Num"/>
		<result property = "i_Num" column = "i_Num"/>
		<result property = "not_Status" column = "not_Status"/>
		<result property = "not_Kind" column = "not_Kind"/>
		<result property = "mem_Id" column = "mem_Id"/>
		<result property = "c_Id" column = "c_Id"/>
	</resultMap>
	
	<resultMap id ="notifyResult02" type = "java.util.Map">
		<result property = "not_Num" column = "not_Num"/>
		<result property = "i_Num" column = "i_Num"/>
		<result property = "not_Status" column = "not_Status"/>
		<result property = "not_Kind" column = "not_Kind"/>
		<result property = "mem_Id" column = "mem_Id"/>
		<result property = "c_Id" column = "c_Id"/>
		<result property = "i_Date" column = "i_Date"/>
		<result property = "i_Content" column = "i_Content" jdbcType="CLOB" javaType="java.lang.String"/>
		<result property = "v_Num" column = "v_Num"/>
	</resultMap>
	
	<resultMap id="replyResult01" type="ReplyVO">
		<!-- property는 화면단에서 쓸 이름, column은 데이터컬럼명이랑 동일 -->
		<result property="i_Num" column="i_Num" />
		<result property="r_Num" column="r_Num" />
		<result property="r_Content" column="r_Content" />
		<result property="r_Date" column="r_Date" />
		<result property="mem_Id" column="mem_Id" />
		<result property="c_Id" column="c_Id" />
	</resultMap>
	
	<select id="viewNotify" resultMap = "notifyResult02" parameterType="java.util.Map">
	<![CDATA[
          select not_Num, i_Num, not_Status, not_Kind, mem_Id, c_Id 
              from notify
              where not_Status = '0'
              and mem_Id = #{mem_Id}
              and not_Kind = '1'      
      ]]>			
	</select>
	
	<select id="viewVote" resultMap="notifyResult02" parameterType="java.util.Map">
	<![CDATA[
		 select c_Id, v_Num
		 from notify
		 where not_Status = '0'
		 and mem_Id = #{mem_Id}
		 and not_Kind = '3'
	 ]]>
	
	</select>
	
	<select id = "searchNotify" resultMap = "notifyResult02" parameterType = "java.util.Map">
	<![CDATA[
	select i.i_Date, i.mem_Id, i.i_Content, i.i_Num, i.c_Id
		from issue i , notify n 
		where i.i_Num = n.i_num
		and n.mem_Id = #{mem_Id}
		and n.not_status = '0'
	]]>
	</select>
	
	<!-- list 뿌려주는 컨트롤러 -->
	<select id = "replyList" resultMap = "notifyResult02" parameterType = "java.util.Map">
	<![CDATA[
	select i.i_Date, i.mem_Id, i.i_Num, i.c_Id, i.i_Content
		from issue i , notify n 
		where i.i_Num = n.i_num
		and i.mem_Id = #{mem_Id}
		and n.not_status = '0'
		and n.not_Kind = '2'
	]]>
	</select>
 
 <insert id="notifyInsert" parameterType = "java.util.Map">
<![CDATA[
	insert into notify(not_Num, i_Num, not_Status, not_Kind, mem_Id, c_Id)
    select notify_seq.nextval,#{i_Num},'0','1',mem_Id,c_Id 
    from co_member
    where c_Id = #{c_Id}
    and mem_Id not in #{mem_Id}
	]]>
</insert>
	
<insert id="replyInsertNotify" parameterType="replyVO">
<![CDATA[
    merge into notify n
    using (select mem_Id from issue where i_Num = #{i_Num})i
    on (i.mem_Id = #{mem_Id})
    when not matched then
    insert(not_Num, i_Num, not_Status, not_Kind, mem_Id, c_Id)
    values(notify_seq.nextval,#{i_Num},'0','2',i.mem_Id,#{c_Id})
]]>
</insert>

<insert id="voteInsertNotify" parameterType ="java.util.Map">
<![CDATA[
	insert into notify(not_Num,v_Num, not_Status, not_Kind, mem_Id, c_Id)
    select notify_seq.nextval,#{v_Num},'0','3',mem_Id,c_Id 
    from co_member
    where c_Id = #{c_Id}
    and mem_Id not in #{mem_Id}
]]>
</insert>

<insert id="votereplyInsertNotify" parameterType="voteReplyVO">
<![CDATA[
    merge into notify n
    using (select mem_Id from vote where v_Num = #{v_Num})i
    on (i.mem_Id = #{mem_Id})
    when not matched then
    insert(not_Num, v_Num, not_Status, not_Kind, mem_Id, c_Id)
    values(notify_seq.nextval,#{v_Num},'0','4',i.mem_Id,#{c_Id})
]]>
</insert>

<!-- 개수세는 컨트롤러 -->
<select id="viewReply" resultMap = "notifyResult02" parameterType="java.util.Map">
	<![CDATA[
         select i_Num, c_Id
			from issue
			where mem_Id = #{mem_Id}
			and i_Num in ( select i_Num from notify where not_Kind = '2'
			and not_Status = '0')
         
      ]]>			
</select>
	
	<update id ="notifyUpdate" parameterType = "java.util.Map">
	<![CDATA[
	update notify set not_Status = '1'
	where i_Num = #{i_Num}
	and mem_Id = #{mem_Id}
	  ]]>
	</update>
	
	<update id ="replyUpdate" parameterType = "java.util.Map">
	<![CDATA[
	update notify set not_Status = '1'
	where i_Num = #{i_Num}
	and c_Id = #{c_Id}
	and not_Kind = '2'
	
	]]>
	</update>
	
	<update id ="voteUpdate" parameterType = "java.util.Map">
	<![CDATA[
	update notify set not_Status = '1'
	where v_Num = #{v_Num}
	and c_Id = #{c_Id}
	and not_Kind = '3'
	and not_Status = '0'
	
	]]>
	</update>
	
	<update id ="votereplyUpdate" parameterType = "java.util.Map">
	<![CDATA[
	update notify set not_Status = '1'
	where v_Num = #{v_Num}
	and c_Id = #{c_Id}
	and not_Kind = '4'
	
	]]>
	</update>

</mapper>