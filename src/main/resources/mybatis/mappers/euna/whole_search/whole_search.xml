<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="whole_search">

	
	<resultMap id="whole_searchResult01" type="java.util.HashMap">
		<!-- property는 화면단에서 쓸 이름, column은 데이터컬럼명이랑 동일 -->
		<result property="i_Num" column="i_Num"/>
		<result property="c_Id" column="c_Id" />
		<result property="i_Name" column="i_Name" />
		<result property="i_Date" column="i_Date" />
		<result property="ig_Num" column="ig_Num" />
		<result property="mem_Id" column="mem_Id" />
		<result property="c_Name" column="c_Name" />
		<result property="mem_Name" column="mem_Name" />
		<result property="ig_Name" column="ig_Name" />
		<result property="wr_mem_Id" column="wr_mem_Id" />
		<result property="rnum" column="rnum" />
		<result property="i_Content" column="i_Content" />
		<result property="keyword" column="keyword" />
	</resultMap>
	
	<resultMap id="whole_searchResult02" type="SearchVO">
		<!-- property는 화면단에서 쓸 이름, column은 데이터컬럼명이랑 동일 -->
		<result property="searchType" column="searchType"/>
		<result property="keyword" column="keyword" />
	</resultMap>

<!-- 이슈검색 뷰 -->
<!-- <select id="searchIssue" resultMap="whole_searchResult01" parameterType="java.util.HashMap"> 
      <![CDATA[
    	select i_Num, c_Id, i_Name, i_Date, ig_Num, wr_mem_Id, c_Name, mem_Name, ig_Name, row_number() over(order by i_date desc) as rnum, i_Content
          from
              (
              (select I.I_NUM as i_Num, I.C_ID as c_Id, I.I_NAME as i_Name, I.I_DATE as i_Date, I.IG_NUM as ig_Num, I.MEM_ID as wr_mem_Id, I.I_CONTENT as i_Content,
                      C.C_NAME as c_Name,
                      M.MEM_NAME as mem_Name,
                      IG.IG_NAME as ig_Name
               from ISSUE I, CO_WORK C, MEMBER M, ISSUE_GROUP IG
               where C.C_ID=I.C_ID
               and M.MEM_ID=I.MEM_ID
               and I.IG_NUM = IG.IG_NUM
               
               and C.C_ID IN
                  (
                  select C_ID from CO_MEMBER where MEM_ID=#{mem_Id}
                  )
                
               )
              union all
              (select P.P_NUM as i_Num, P.MEM_ID as c_Id, P.P_I_NAME as i_Name, P.P_I_DATE as i_Date, null as ig_Num, P.MEM_ID as wr_mem_Id, P.P_I_CONTENT as i_content,
                      null as c_Name,
                      M.MEM_NAME as mem_Name,
                      '내 공간' as ig_Name
                  from PERSONAL P, MEMBER M
                  where M.MEM_ID=P.MEM_ID
              )
          )
               	]]>
           <trim prefix="WHERE" prefixOverrides="AND|OR">
				<if test="searchType=='i_Name' and keyword != null and keyword != '' ">
					AND I_NAME like CONCAT('%' || #{keyword}, '%')
				</if>
				<if test="searchType=='i_Content' and keyword != null and keyword != '' ">
					AND I_CONTENT like CONCAT('%' || #{keyword}, '%')
				</if>
				<if test="searchType=='wr_mem_Id' and keyword != null and keyword != '' ">
					AND WR_MEM_ID like CONCAT('%' || #{keyword}, '%')
				</if>	
				<if test="searchType=='mem_Name' and keyword != null and keyword != '' ">
					AND MEM_NAME like CONCAT('%' || #{keyword}, '%')
				</if>
		</trim>


	</select> -->
	
	
	
	<select id="searchIssue" resultMap="whole_searchResult01" parameterType="project.euna.whole_search.vo.Criteria"> 
      <![CDATA[
 
 select rnum, i_Num, c_Id, i_Name, i_Date, ig_Num, wr_mem_Id, c_Name, mem_Name, ig_Name, i_Content
 from
 (
        select i_Num, c_Id, i_Name, i_Date, ig_Num, wr_mem_Id, c_Name, mem_Name, ig_Name, row_number() over(order by i_date desc) as rnum, i_Content
                  from
                      (
                      (select I.I_NUM as i_Num, I.C_ID as c_Id, I.I_NAME as i_Name, I.I_DATE as i_Date, I.IG_NUM as ig_Num, I.MEM_ID as wr_mem_Id, I.I_CONTENT as i_Content,
                              C.C_NAME as c_Name,
                              M.MEM_NAME as mem_Name,
                              IG.IG_NAME as ig_Name
                       from ISSUE I, CO_WORK C, MEMBER M, ISSUE_GROUP IG
                       where C.C_ID=I.C_ID
                       and M.MEM_ID=I.MEM_ID
                       and I.IG_NUM = IG.IG_NUM
                       
                       and C.C_ID IN
                          (
                          select C_ID from CO_MEMBER where MEM_ID=#{mem_Id}
                          )
                        
                       )
                      union all
                      (select P.P_NUM as i_Num, P.MEM_ID as c_Id, P.P_I_NAME as i_Name, P.P_I_DATE as i_Date, null as ig_Num, P.MEM_ID as wr_mem_Id, P.P_I_CONTENT as i_content,
                              null as c_Name,
                              M.MEM_NAME as mem_Name,
                              null as ig_Name
                          from PERSONAL P, MEMBER M
                          where M.MEM_ID=P.MEM_ID
                      )
                  )
                       ]]>
       <where>
				<if test="keyword != null and keyword != '' ">
					AND (I_NAME || I_CONTENT) like CONCAT('%' || #{keyword}, '%')
				</if>
		</where>
              
     <![CDATA[
     )
    where rnum between #{rowStart} and #{rowEnd}
    order by to_number(i_Num) desc
     ]]>


    


	</select>
	
	
	<!-- 이슈 검색결과 총 갯수 -->
	<select id="issueCount" resultType="int" parameterType="project.euna.whole_search.vo.Criteria"> 
      <![CDATA[
           select count(i_Num)
                  from
                      (
                      (select I.I_NUM as i_Num, I.C_ID as c_Id, I.I_NAME as i_Name, I.I_DATE as i_Date, I.IG_NUM as ig_Num, I.MEM_ID as wr_mem_Id, I.I_CONTENT as i_Content,
                              C.C_NAME as c_Name,
                              M.MEM_NAME as mem_Name,
                              IG.IG_NAME as ig_Name
                       from ISSUE I, CO_WORK C, MEMBER M, ISSUE_GROUP IG
                       where C.C_ID=I.C_ID
                       and M.MEM_ID=I.MEM_ID
                       and I.IG_NUM = IG.IG_NUM
                       
                       and C.C_ID IN
                          (
                          select C_ID from CO_MEMBER where MEM_ID='dmsdk@dmsdk.com'
                          )
                        
                       )
                      union all
                      (select P.P_NUM as i_Num, P.MEM_ID as c_Id, P.P_I_NAME as i_Name, P.P_I_DATE as i_Date, null as ig_Num, P.MEM_ID as wr_mem_Id, P.P_I_CONTENT as i_content,
                              null as c_Name,
                              M.MEM_NAME as mem_Name,
                              null as ig_Name
                          from PERSONAL P, MEMBER M
                          where M.MEM_ID=P.MEM_ID
                      )
                  )
      ]]>
       <where>
				<if test="keyword != null and keyword != '' ">
					AND (I_NAME || I_CONTENT) like CONCAT('%' || #{keyword}, '%')
				</if>
		</where>

	</select>
	
	
	
	
	
	
</mapper>